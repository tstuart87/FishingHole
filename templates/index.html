<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Indiana Waterway Monitor</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:      #29260a;
      --surface: #16221a;
      --border:  #26372d;
      --accent:  #dd8f3b;
      --accent2: #dd8f3b;
      --text:    #e6edf3;
      --muted:   #8b949e;
      --mono:    'Barlow Condensed', monospace;
      --sans:    'Barlow Condensed', sans-serif;
      --green:   #3fb950;
      --yellow:  #d29922;
      --red:     #f85149;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      min-height: 100vh;
    }

    /* ── Header ───────────────────────────────────────────── */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-mark {
      width: 36px;
      height: 36px;
      border: 2px solid var(--accent);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .site-title {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text);
    }

    .site-subtitle {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      color: var(--muted);
      text-transform: uppercase;
    }

    .refresh-btn {
      background: transparent;
      border: 1px solid var(--accent2);
      color: var(--accent);
      font-family: var(--sans);
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 0.4rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.15s, color 0.15s;
    }

    .refresh-btn:hover { background: var(--accent2); color: #fff; }
    .refresh-btn.spinning svg { animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Main ─────────────────────────────────────────────── */
    main {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* ── Controls ─────────────────────────────────────────── */
    .controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    .sort-label {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .sort-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: var(--sans);
      font-size: 0.78rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 0.45rem 0.9rem;
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
    }

    .sort-btn:hover, .sort-btn.active {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* ── Table ────────────────────────────────────────────── */
    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    table { width: 100%; border-collapse: collapse; table-layout: fixed; }

    /* Column widths: site name gets remaining space, data cols are fixed */
    thead th:nth-child(1) { width: auto; }
    thead th:nth-child(2) { width: 90px; }
    thead th:nth-child(3) { width: 90px; }
    thead th:nth-child(4) { width: 48px; }

    thead tr {
      background: #0d1117;
      border-bottom: 1px solid var(--border);
    }

    thead th {
      padding: 0.85rem 1.25rem;
      text-align: left;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      white-space: nowrap;
    }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.1s;
      animation: fadeIn 0.3s ease both;
    }

    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(59,158,221,0.05); }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: none; }
    }

    td {
      padding: 0.9rem 1rem;
      font-size: 0.9rem;
      vertical-align: middle;
    }

    /* Pin column — centered, no overflow */
    td:last-child {
      padding: 0.9rem 0.5rem;
      text-align: center;
    }

    .site-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text);
      line-height: 1.4;
      word-break: break-word;
    }

    /* Part before the dash — larger, all caps via existing text */
    .name-main {
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--text);
    }

    /* Part after the dash — smaller, sentence case, muted */
    .name-sub {
      font-weight: 400;
      font-size: 0.78rem;
      color: var(--muted);
      text-transform: none;
    }

    .reading {
      font-family: var(--mono);
      font-size: 1rem;
    }

    .reading.na { color: var(--muted); font-size: 0.8rem; }

    /* Small grey unit suffix inline with number */
    .reading-unit {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--muted);
    }

    .temp-secondary {
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 0.15rem;
    }

    /* Pin drop button */
    .pin-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      background: transparent;
      border: 1px solid var(--accent2);
      border-radius: 4px;
      color: var(--accent);
      cursor: pointer;
      text-decoration: none;
      transition: background 0.15s, color 0.15s;
    }

    .pin-btn:hover { background: var(--accent2); color: #fff; }

    .pin-btn.no-coords {
      border-color: var(--border);
      color: var(--muted);
      cursor: default;
      pointer-events: none;
    }

    /* ── Loading / Error ──────────────────────────────────── */
    .state-row td {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 0.85rem;
    }

    .spinner {
      display: inline-block;
      width: 20px; height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin-bottom: 0.75rem;
    }

    /* ── Footer ───────────────────────────────────────────── */
    footer {
      text-align: center;
      padding: 2rem;
      font-size: 0.72rem;
      color: var(--muted);
      border-top: 1px solid var(--border);
      margin-top: 3rem;
      font-family: var(--mono);
    }

    footer a { color: var(--accent); text-decoration: none; }
    footer a:hover { text-decoration: underline; }

    @media (max-width: 600px) {
      header { padding: 0 1rem; }
      main   { padding: 0.75rem; }
      .site-subtitle { display: none; }
      td { padding: 0.75rem 0.6rem; }
      td:last-child { padding: 0.75rem 0.3rem; }
      thead th { padding: 0.75rem 0.6rem; }
    }
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="logo-mark">
      <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#dd8f3b"><path d="M270-190q-70-70-70-170v-240l200 200-56 57-64-64v47q0 66 47 113t113 47q66 0 113-47t47-113v-127q-36-14-58-44.5T520-600q0-38 22-68.5t58-44.5v-167h80v167q36 14 58 44.5t22 68.5q0 38-22 69t-58 44v127q0 100-70 170t-170 70q-100 0-170-70Zm398.5-381.5Q680-583 680-600t-11.5-28.5Q657-640 640-640t-28.5 11.5Q600-617 600-600t11.5 28.5Q623-560 640-560t28.5-11.5ZM640-600Z"/></svg>
    </div>
    <div>
      <div class="site-title">TREV'S HOLE PICKER</div>
      <div class="site-subtitle">USGS Real-Time Data</div>
    </div>
  </div>
  <button class="refresh-btn" id="refresh-btn" onclick="loadData()">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
    </svg>
  </button>
</header>

<main>
  <div class="controls">
    <span class="sort-label">Sort:</span>
    <button class="sort-btn active" id="sort-name" onclick="sortBy('name')">Name</button>
    <button class="sort-btn"        id="sort-gage" onclick="sortBy('gage')">Gage</button>
    <button class="sort-btn"        id="sort-temp" onclick="sortBy('temp')">Temp</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Site</th>
          <th>Gage Height</th>
          <th>Water Temp</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr class="state-row">
          <td colspan="4">
            <div class="spinner"></div><br/>
            Loading crick data...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</main>

<footer>
  Data sourced from <a href="https://waterservices.usgs.gov" target="_blank">USGS Water Services</a>
  &nbsp;·&nbsp; Updated every 15–60 min by USGS &nbsp;·&nbsp; Dashboard refreshes on demand
</footer>

<script>
  let allData = [];
  let sortKey = 'name';
  let sortDir = 1;

  async function loadData() {
    const btn = document.getElementById('refresh-btn');
    btn.classList.add('spinning');
    try {
      const res = await fetch('/api/data');
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      allData = await res.json();
      renderTable();
    } catch (err) {
      document.getElementById('table-body').innerHTML = `
        <tr class="state-row">
          <td colspan="4">
            &#9888; Could not reach /api/data — is the Flask server running?<br/>
            <small>${err.message}</small>
          </td>
        </tr>`;
    } finally {
      btn.classList.remove('spinning');
    }
  }

  function toSentenceCase(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
  }

  function formatName(raw) {
    const cleaned = raw.replace(/, IN$/i, '');
    // Split on " - " separator we'll introduce, or on AT/NEAR
    const match = cleaned.match(/^(.+?)\s+(?:AT|NEAR)\s+(.+)$/i);
    if (match) {
      const main = match[1].trim();
      const sub  = toSentenceCase(match[2].trim());
      return `<span class="name-main">${main}</span> <span class="name-sub">- ${sub}</span>`;
    }
    // No AT/NEAR found — just return as-is
    return `<span class="name-main">${cleaned}</span>`;
  }

  function mapsUrl(lat, lng) {
    return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
  }

  function renderTable() {
    let data = [...allData];

    data.sort((a, b) => {
      if (sortKey === 'name') return sortDir * a.name.localeCompare(b.name);
      if (sortKey === 'gage') return sortDir * ((parseFloat(a.gage_height_ft) || 0) - (parseFloat(b.gage_height_ft) || 0));
      if (sortKey === 'temp') return sortDir * ((a.avg_temp_f || 0) - (b.avg_temp_f || 0));
      return 0;
    });

    const tbody = document.getElementById('table-body');

    if (data.length === 0) {
      tbody.innerHTML = `<tr class="state-row"><td colspan="4">No data available.</td></tr>`;
      return;
    }

    tbody.innerHTML = data.map((r, i) => {
      const gage  = r.gage_height_ft != null ? parseFloat(r.gage_height_ft).toFixed(2) : null;
      const tempF = r.avg_temp_f != null ? r.avg_temp_f.toFixed(1) : null;
      const tempC = r.avg_temp_c != null ? r.avg_temp_c.toFixed(1) : null;

      const hasCoords = r.lat !== 0.0 && r.lng !== 0.0;
      const pinBtn = hasCoords
        ? `<a class="pin-btn" href="${mapsUrl(r.lat, r.lng)}" target="_blank" rel="noopener" title="Get directions">
             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
               <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
             </svg>
           </a>`
        : `<span class="pin-btn no-coords" title="No coordinates set">
             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
               <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
             </svg>
           </span>`;

      return `
      <tr style="animation-delay:${i * 0.04}s">
        <td><div class="site-name">${formatName(r.name)}</div></td>
        <td>
          ${gage
            ? `<span class="reading">${gage}<span class="reading-unit">ft</span></span>`
            : `<span class="reading na">N/A</span>`}
        </td>
        <td>
          ${tempF
            ? `<div class="reading">${tempF}°F</div>
               <div class="temp-secondary">${tempC}°C</div>`
            : `<span class="reading na">N/A</span>`}
        </td>
        <td>${pinBtn}</td>
      </tr>`;
    }).join('');
  }

  function sortBy(key) {
    if (sortKey === key) { sortDir *= -1; }
    else { sortKey = key; sortDir = 1; }
    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('sort-' + key).classList.add('active');
    renderTable();
  }

  loadData();
</script>
</body>
</html>